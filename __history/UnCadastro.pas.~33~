unit UnCadastro;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, Data.DB,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client, Vcl.ExtCtrls, Vcl.StdCtrls,
  Vcl.ToolWin, Vcl.ComCtrls, Vcl.Mask, Vcl.DBCtrls, Vcl.Grids, Vcl.DBGrids;

type
  TfrmCadastros = class(TForm)
    qCad: TFDQuery;
    dsCad: TDataSource;
    Panel1: TPanel;
    Panel2: TPanel;
    Panel3: TPanel;
    Panel4: TPanel;
    pnlBotoes: TPanel;
    ToolBar1: TToolBar;
    btSalvar: TToolButton;
    btEditar: TToolButton;
    btCancelar: TToolButton;
    btExcuir: TToolButton;
    ToolButton5: TToolButton;
    btPrimeiro: TToolButton;
    btAnterior: TToolButton;
    btProximo: TToolButton;
    btUltimo: TToolButton;
    btNovo: TToolButton;
    Shape1: TShape;
    Label1: TLabel;
    EditCodigo: TDBEdit;
    Label2: TLabel;
    EditNome: TDBEdit;
    Label3: TLabel;
    rdgTipo: TDBRadioGroup;
    Panel5: TPanel;
    GridCorpoCad: TDBGrid;
    qCorpoCad: TFDQuery;
    dsCorpoCad: TDataSource;
    ToolBar2: TToolBar;
    btCancelarCorpoCad: TToolButton;
    btNovoCorpoCad: TToolButton;
    btSalvarCorpoCad: TToolButton;
    Shape2: TShape;
    Label4: TLabel;
    Label5: TLabel;
    Shape3: TShape;
    dtpNascimento: TDateTimePicker;
    qCadAux: TFDQuery;
    MaskEdit1: TMaskEdit;
    procedure FormDestroy(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure qCadAfterScroll(DataSet: TDataSet);
    procedure btPrimeiroClick(Sender: TObject);
    procedure btAnteriorClick(Sender: TObject);
    procedure btProximoClick(Sender: TObject);
    procedure btUltimoClick(Sender: TObject);
    procedure qCadBeforePost(DataSet: TDataSet);
    procedure btEditarClick(Sender: TObject);
    procedure btNovoClick(Sender: TObject);
    procedure qCadAfterPost(DataSet: TDataSet);
    procedure btSalvarClick(Sender: TObject);
    procedure btCancelarClick(Sender: TObject);
    procedure btExcuirClick(Sender: TObject);
    procedure qCadBeforeEdit(DataSet: TDataSet);
    procedure dtpNascimentoCloseUp(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmCadastros: TfrmCadastros;

implementation

uses
  unPrincipal;

{$R *.dfm}

procedure TfrmCadastros.btAnteriorClick(Sender: TObject);
var
  liCod: integer;
begin
  liCod := qCad.FieldByName('CODIGO').AsInteger;
  qCad.Close;
  qCad.SQL.Text := 'SELECT FIRST 2 * FROM CADASTRO WHERE CODIGO < ' + liCod.ToString+
    'ORDER BY CODIGO DESC';
  qCad.Open;
  if qCad.RecordCount = 1 then
  begin
    btAnterior.Enabled := False;
    btPrimeiro.Enabled := False;
  end;
  btProximo.Enabled := True;
  btUltimo.Enabled := True;
end;

procedure TfrmCadastros.btCancelarClick(Sender: TObject);
begin
  qCad.Cancel;
end;

procedure TfrmCadastros.btEditarClick(Sender: TObject);
begin
  qCad.Edit;
  EditCodigo.Enabled := False;
end;

procedure TfrmCadastros.btExcuirClick(Sender: TObject);
begin
  qCad.Delete;
  qCad.ApplyUpdates(-1);
end;

procedure TfrmCadastros.btNovoClick(Sender: TObject);
begin
  qCadAux.Close;
  qCadAux.SQL.Text := 'SELECT MAX(CODIGO) CODIGO FROM CADASTRO';
  qCadAux.Open;
  qCad.Append;
  qCad.FieldByName('CODIGO').AsInteger := qCadAux.FieldByName('CODIGO').AsInteger;
  EditCodigo.Enabled := False;
end;

procedure TfrmCadastros.btPrimeiroClick(Sender: TObject);
begin
  qCad.Close;
  qCad.SQL.Text := 'SELECT FIRST 2 * FROM CADASTRO ORDER BY CODIGO';
  qCad.Open;
  btAnterior.Enabled := False;
  btPrimeiro.Enabled := False;
  btProximo.Enabled := True;
  btUltimo.Enabled := True;
end;

procedure TfrmCadastros.btProximoClick(Sender: TObject);
var
  liCod: integer;
begin
  liCod := qCad.FieldByName('CODIGO').AsInteger;
  qCad.Close;
  qCad.SQL.Text := 'SELECT FIRST 2 * FROM CADASTRO WHERE CODIGO > ' + liCod.ToString +
    'ORDER BY CODIGO';
  qCad.Open;
  if qCad.RecordCount = 1 then
  begin
    btProximo.Enabled := False;
    btUltimo.Enabled := False;
  end;
  btAnterior.Enabled := True;
  btPrimeiro.Enabled := True;
end;

procedure TfrmCadastros.btSalvarClick(Sender: TObject);
begin
  qCad.Post;
end;

procedure TfrmCadastros.btUltimoClick(Sender: TObject);
begin
  qCad.Close;
  qCad.SQL.Text := 'SELECT FIRST 1 * FROM CADASTRO ORDER BY CODIGO DESC';
  qCad.Open;
  btAnterior.Enabled := True;
  btPrimeiro.Enabled := True;
  btProximo.Enabled := False;
  btUltimo.Enabled := False;
end;

procedure TfrmCadastros.dtpNascimentoCloseUp(Sender: TObject);
begin
  if not (qCad.State in [dsEdit, dsInsert]) then
    dtpNascimento.Date := qCad.FieldByName('DT_NASC').AsDateTime;
end;

procedure TfrmCadastros.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action := caFree;
end;

procedure TfrmCadastros.FormCreate(Sender: TObject);
begin
  btUltimoClick(btUltimo);
  dtpNascimento.MaxDate := now;
end;

procedure TfrmCadastros.FormDestroy(Sender: TObject);
begin
  frmCadastros := nil;
end;

procedure TfrmCadastros.qCadAfterPost(DataSet: TDataSet);
begin
  qCad.ApplyUpdates(-1);
  EditCodigo.Enabled := True;
  EditNome.ReadOnly := True;
  rdgTipo.ReadOnly := True;
end;

procedure TfrmCadastros.qCadAfterScroll(DataSet: TDataSet);
begin
  dtpNascimento.DateTime := qCad.FieldByName('DT_NASC').AsDateTime;
end;

procedure TfrmCadastros.qCadBeforeEdit(DataSet: TDataSet);
begin
  EditNome.ReadOnly := False;
  rdgTipo.ReadOnly := False;
end;

procedure TfrmCadastros.qCadBeforePost(DataSet: TDataSet);
begin
  if dtpNascimento.DateTime <> qCad.FieldByName('DT_NASC').AsDateTime then
    qCad.FieldByName('DT_NASC').AsDateTime := dtpNascimento.DateTime;
end;

end.
